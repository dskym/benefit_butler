import { Category, Transaction } from '../types';

/**
 * 기본 카테고리명 → 가맹점 키워드 목록
 * 키는 backend/app/services/category.py의 DEFAULT_CATEGORIES name과 일치해야 함.
 */
export const MERCHANT_KEYWORDS: Record<string, string[]> = {
  // ── 식비 ─────────────────────────────────────────────────────────────────
  식비: [
    // 카페
    '스타벅스', '이디야', '투썸플레이스', '투썸', '할리스', '메가커피', '빽다방',
    '커피빈', '폴바셋', '파스쿠찌', '카페베네', '탐앤탐스', '드롭탑', '더벤티',
    '컴포즈커피', '엔제리너스', '커피스미스', '달콤커피', '블루보틀', '매머드커피',
    // 음료/디저트
    '공차', '쥬씨', '스무디킹', '요거프레소', '설빙', '배스킨라빈스',
    '하겐다즈', '나뚜루', '콜드스톤',
    // 편의점
    'GS25', 'CU', '세븐일레븐', '이마트24', '미니스톱',
    // 마트/슈퍼/창고형
    '이마트', '홈플러스', '롯데마트', '코스트코', '하나로마트', '노브랜드',
    '트레이더스', '킴스클럽', '빅마트', '메가마트', '하나로클럽', '롯데슈퍼',
    'GS더프레시', '이마트에브리데이',
    // 패스트푸드/버거
    '맥도날드', '버거킹', '롯데리아', 'KFC', '파이브가이즈', '노브랜드버거',
    '맘스터치', '서브웨이', '쉐이크쉑',
    // 피자
    '파파존스', '도미노', '피자헛', '피자알볼로', '미스터피자', '고피자',
    // 분식
    '김밥천국', '종로김밥', '두끼', '엽기떡볶이', '죠스떡볶이', '신전떡볶이',
    // 치킨
    '교촌', 'BBQ', 'bhc', '굽네치킨', '처갓집', '페리카나', '네네치킨',
    '호식이두마리치킨', '60계치킨', '푸라닭', '또래오래', '멕시카나',
    '스모프치킨', '지코바',
    // 한식/도시락
    '본죽', '본도시락', '한솥', '청년다방', '이삭토스트',
    // 베이커리
    '파리바게뜨', '뚜레쥬르', '파리크라상', '던킨', '크리스피크림',
    '브레댄코', '아티제', '폴앤폴리나',
    // 배달앱 (앱 결제는 식비로)
    '배달의민족', '요기요', '쿠팡이츠',
  ],

  // ── 교통 ─────────────────────────────────────────────────────────────────
  교통: [
    // 대중교통
    '지하철', '버스', '서울교통공사', 'T머니', '캐시비',
    // 택시/모빌리티
    '카카오T', '카카오택시', '우티', '타다', '아이엠택시', '반반택시',
    // 기차
    '코레일', 'KTX', 'SRT', 'ITX', '공항철도', 'AREX',
    // 항공
    '대한항공', '아시아나', '제주항공', '진에어', '티웨이', '에어부산',
    '에어서울', '이스타항공', '에어프레미아',
    // 주유소
    'SK주유소', 'GS칼텍스', '현대오일뱅크', 'S-OIL', '오일뱅크', '알뜰주유소',
    'SK에너지', '에쓰오일', '현대오일',
    // 렌터카/카셰어링
    '쏘카', '그린카', '피플카', '롯데렌탈', 'SK렌터카', 'AJ렌터카',
    '제주렌트', '카카오T바이크',
    // 주차
    '파킹클라우드', '아이파킹', '카카오파킹', '에버파킹',
    // 고속도로
    '한국도로공사', '하이패스', 'ETC',
  ],

  // ── 쇼핑 ─────────────────────────────────────────────────────────────────
  쇼핑: [
    // 온라인 종합
    '쿠팡', '11번가', 'G마켓', '옥션', '위메프', '티몬', 'SSG', '롯데온',
    '카카오쇼핑', '네이버쇼핑', '네이버페이', 'AK몰',
    // 패션/뷰티
    '무신사', '올리브영', '자라', 'H&M', '유니클로', '지오다노', '스파오',
    '에잇세컨즈', '탑텐', '미쏘', '베이직하우스', '폴로',
    // 신발/스포츠
    'ABC마트', '나이키', '아디다스', '뉴발란스', '푸마', '리복', '살로몬',
    '데카트론',
    // 백화점
    '롯데백화점', '현대백화점', '신세계백화점', '갤러리아', 'AK플라자',
    // 아울렛
    '롯데아울렛', '신세계아울렛', '현대아울렛', '마리오아울렛',
    // 가전/디지털
    '삼성전자', 'LG전자', '하이마트', '전자랜드', '애플', '삼성디지털프라자',
    // 생활/인테리어
    '이케아', '한샘', '리바트', '까사미아',
    // 균일가
    '다이소',
    // 서적
    '교보문고', '영풍문고', '알라딘', 'YES24', '반디앤루니스', '인터파크도서',
  ],

  // ── 의료·건강 ──────────────────────────────────────────────────────────────
  '의료·건강': [
    // 약국
    '약국', '약방', '온누리약국', '세종약국',
    // 병원 과별
    '병원', '의원', '클리닉', '한의원', '치과', '안과', '이비인후과',
    '피부과', '정형외과', '내과', '소아과', '산부인과', '비뇨기과',
    '성형외과', '외과', '신경과', '재활의학과', '정신건강의학과',
    '가정의학과', '응급실', '보건소',
    // 헬스/운동
    '헬스장', '헬스클럽', '피트니스', '스포츠센터', '크로스핏',
    '필라테스', '요가', '스피닝',
    // 검진
    '건강검진', '메디체크', '에이치플러스',
  ],

  // ── 주거·통신 ──────────────────────────────────────────────────────────────
  '주거·통신': [
    // 이동통신
    'SKT', 'KT', 'LGU+', 'LG유플러스', 'SK텔레콤', '알뜰폰',
    '헬로모바일', 'KT엠모바일', 'SK세븐모바일',
    // 인터넷/TV
    'SK브로드밴드', 'KT인터넷', 'LG헬로비전', 'B tv', '올레tv', 'U+TV',
    // 전기/가스/난방
    '한국전력', '한전', '도시가스', '지역난방', '서울도시가스',
    '귀뚜라미', '경동나비엔',
    // 관리비/임대
    '관리비', '아파트관리', '월세', '전기세', '가스비', '수도요금',
  ],

  // ── 문화·여가 ──────────────────────────────────────────────────────────────
  '문화·여가': [
    // 영화
    'CGV', '롯데시네마', '메가박스', '씨네큐',
    // 음악 스트리밍
    '멜론', '지니', '벅스', '플로', '스포티파이',
    // OTT
    '넷플릭스', '왓챠', '웨이브', '티빙', '쿠팡플레이', '디즈니플러스',
    '애플TV', '유튜브프리미엄',
    // 게임/앱스토어
    '스팀', '구글플레이', '앱스토어', '넥슨', '엔씨소프트', '카카오게임즈',
    '넷마블', '블리자드', '펍지',
    // 스포츠/레저
    '볼링장', '당구장', '스크린골프', '방탈출', '노래방', 'PC방',
    '워터파크', '놀이공원', '에버랜드', '롯데월드', '스키장',
    '무주리조트', '비발디파크',
    // 여행/숙박
    '야놀자', '여기어때', '에어비앤비', '부킹닷컴', '호텔스컴바인',
    '익스피디아', '아고다', '인터컨티넨탈', '롯데호텔',
    '신라호텔', '힐튼', '메리어트', '조선호텔',
    // 공연/전시
    '인터파크티켓', '예스24티켓', '멜론티켓', '티켓링크',
    '예술의전당', '세종문화회관',
  ],

  // ── 교육 ─────────────────────────────────────────────────────────────────
  교육: [
    // 어학
    '영어학원', '토익', '토플', '아이엘츠', '영단기', '해커스', '시원스쿨',
    'YBM', '파고다', '민병철', '스피쿠스', '링글', '화상영어',
    // 입시/보습
    '대성학원', '종로학원', '메가스터디', '이투스',
    // 온라인 교육
    '클래스101', '패스트캠퍼스', '인프런', '유데미', '코드잇',
    '스파르타코딩클럽', '엘리스', '제로베이스',
    // 공무원/자격증
    '공단기', '에듀윌', '해커스공무원',
    // 악기/예체능
    '피아노학원', '미술학원',
    // 유아/초등
    '눈높이', '웅진씽크빅', '빨간펜', '구몬',
  ],

  // ── 금융 ─────────────────────────────────────────────────────────────────
  금융: [
    // 보험
    '삼성생명', '한화생명', '교보생명', '흥국생명', '동양생명',
    '현대해상', '삼성화재', 'DB손해보험', 'KB손해보험',
    '메리츠화재', '롯데손해보험', '한화손해보험',
    // 증권/투자
    '키움증권', '미래에셋', '삼성증권', 'NH투자증권', 'KB증권',
    '한국투자증권', '대신증권', '신한금융투자', '하나금융투자',
    // 카드 연회비/대출
    '연회비', '카드연회비', '대출이자', '이자납부',
  ],

  // ── 경조사 ────────────────────────────────────────────────────────────────
  경조사: [
    // 꽃/화환
    '꽃집', '플라워', '꽃배달', '화환', '부케', '꽃다발',
    '블룸앤굿', '꽃보다', '꽃피다',
    // 선물/상품권
    '선물세트', '상품권', '기프티콘', '기프트카드', '카카오선물',
    // 예식/장례
    '예식장', '웨딩홀', '스드메', '장례식장', '장례비',
    // 돌잔치/케이터링
    '돌잔치', '케이터링',
  ],
};

/**
 * SMS 카드 접두어 제거, 공백 정리, 소문자 변환
 * "[국민카드] 스타벅스 강남점" → "스타벅스 강남점"
 */
export function normalizeDescription(description: string): string {
  return description
    .replace(/\[.*?\]/g, '') // [국민카드], [신한카드] 등 제거
    .replace(/\s+/g, ' ')    // 다중 공백 단일화
    .trim()
    .toLowerCase();
}

export interface SuggestResult {
  categoryId: string;
  method: 'history' | 'keyword';
}

/**
 * description + 사용자 히스토리 + 카테고리 목록을 받아 추천 카테고리를 반환하는 순수 함수.
 *
 * 처리 순서:
 *   1. 최근 300건 히스토리에서 동일 type, description 포함 거래의 가장 많이 쓴 category_id
 *   2. MERCHANT_KEYWORDS 키워드 토큰 매칭
 *   3. 없으면 null
 */
export function suggestCategory(
  description: string,
  transactionType: string,
  transactions: Transaction[],
  categories: Category[],
): SuggestResult | null {
  if (description.length < 2) return null;

  const normalized = normalizeDescription(description);
  const tokens = normalized.split(' ').filter(t => t.length >= 2);

  // Step 1: 히스토리 검색 — 최근 300건만
  const freq: Record<string, number> = {};
  transactions
    .slice(0, 300)
    .filter(
      t =>
        t.type === transactionType &&
        t.category_id != null &&
        normalizeDescription(t.description ?? '').includes(normalized),
    )
    .forEach(t => {
      freq[t.category_id!] = (freq[t.category_id!] ?? 0) + 1;
    });

  const topEntry = Object.entries(freq).sort((a, b) => b[1] - a[1])[0];
  if (topEntry) return { categoryId: topEntry[0], method: 'history' };

  // Step 2: 키워드 규칙 — 토큰 단위 매칭
  for (const [catName, keywords] of Object.entries(MERCHANT_KEYWORDS)) {
    const matched = keywords.some(k =>
      tokens.some(
        token =>
          token.includes(k.toLowerCase()) || k.toLowerCase().includes(token),
      ),
    );
    if (matched) {
      const cat = categories.find(
        c => c.name === catName && c.type === transactionType,
      );
      if (cat) return { categoryId: cat.id, method: 'keyword' };
    }
  }

  return null;
}
